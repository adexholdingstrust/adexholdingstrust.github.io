<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Executive Report | Adex Holdings Trust</title>

  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="assets/styles.css"/>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Mapbox -->
  <link
    href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css"
    rel="stylesheet"
  />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <style>
    .report-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:28px;
    }

    .report-title h1 {
      margin:0;
      font-size:30px;
    }

    .report-title p {
      margin:6px 0 0;
      opacity:.7;
    }

    .grid {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:18px;
    }

    .metric {
      padding:20px;
      border-radius:14px;
      background:linear-gradient(135deg,#111,#1b1b1b);
      border:1px solid var(--line);
    }

    .metric h3 {
      margin:0;
      font-size:13px;
      opacity:.7;
      text-transform:uppercase;
      letter-spacing:.04em;
    }

    .metric .value {
      font-size:34px;
      margin-top:8px;
      font-weight:600;
    }

    .metric .delta {
      margin-top:6px;
      font-size:13px;
      opacity:.8;
    }

    .up { color:#3ddc97; }
    .down { color:#ff6b6b; }

    .section {
      margin-top:42px;
    }

    .section h2 {
      margin-bottom:14px;
      font-size:22px;
    }

    canvas {
      background:#0f0f0f;
      border-radius:14px;
      padding:14px;
    }

    #geoMap {
      height:420px;
      border-radius:16px;
      border:1px solid var(--line);
    }

    .insight {
      background:#101010;
      border-left:4px solid #4da3ff;
      padding:16px 18px;
      border-radius:10px;
      margin-top:14px;
    }
  </style>
</head>

<body>
<div class="container">

  <!-- HEADER -->
  <div class="report-header">
    <div class="report-title">
      <h1>Executive Intelligence Report</h1>
      <p>Portfolio engagement, demand signals, and strategic trends</p>
    </div>
    <div class="small">
      Last updated:
      <span id="reportTime"></span>
    </div>
  </div>

  <!-- KPI GRID -->
  <div class="grid" id="kpiGrid"></div>

  <!-- ENGAGEMENT CHART -->
  <div class="section">
    <h2>Engagement Trend</h2>
    <canvas id="engagementChart" height="120"></canvas>
  </div>

  <!-- GEOGRAPHIC DEMAND -->
  <div class="section">
    <h2>Geographic Demand Map</h2>
    <div id="geoMap"></div>
  </div>

  <!-- AI INSIGHTS -->
  <div class="section">
    <h2>Executive Insights</h2>
    <div id="insights"></div>
  </div>

  <div class="footer">
    <div class="hr"></div>
    <div class="small">
      Confidential • Executive Use Only • © 2025 Adex Holdings Trust
    </div>
  </div>

</div>

<script src="assets/app.js"></script>

<script>
(async function(){

  /* =============================
     TIME
  ============================= */
  document.getElementById("reportTime").textContent =
    new Date().toLocaleString("en-US",{ timeZone:"America/Los_Angeles" });

  /* =============================
     SAFE FETCH HELPERS
  ============================= */
  async function safeJSON(url) {
    try {
      const res = await accessFetch(url);
      if (!res || !res.ok) return null;
      return await res.json();
    } catch {
      return null;
    }
  }

  /* =============================
     KPI DATA
  ============================= */
  const k7  = await safeJSON("/admin/kpi?days=7")  || {};
  const k30 = await safeJSON("/admin/kpi?days=30") || {};

  function metric(title,value,delta,dir){
    return `
      <div class="metric">
        <h3>${title}</h3>
        <div class="value">${(value ?? 0).toLocaleString()}</div>
        <div class="delta ${dir}">
          ${dir==="up"?"↑":"↓"} ${delta}
        </div>
      </div>
    `;
  }

  document.getElementById("kpiGrid").innerHTML =
    metric("7-Day Events",k7.totalEvents,"vs baseline","up") +
    metric("30-Day Events",k30.totalEvents,"trend window","up") +
    metric("Property Views",k7.views,"engagement","up") +
    metric("High Severity",k7.highSeverity,"buyer signals","up");

  /* =============================
     ENGAGEMENT CHART
  ============================= */
  const series = await safeJSON("/admin/engagement/timeseries") || [];

  new Chart(
    document.getElementById("engagementChart"),
    {
      type:"line",
      data:{
        labels: series.map(x=>x.date || ""),
        datasets:[{
          label:"Engagement",
          data: series.map(x=>x.count || 0),
          borderColor:"#4da3ff",
          tension:.35
        }]
      },
      options:{
        plugins:{ legend:{ display:false }},
        scales:{
          x:{ ticks:{ color:"#aaa" }},
          y:{ ticks:{ color:"#aaa" }}
        }
      }
    }
  );

  /* =============================
     GEO MAP (SAFE)
  ============================= */
  let geo = { type:"FeatureCollection", features:[] };

  try {
    const data = await safeJSON("/admin/heatmap?days=30");
    if (data && data.type==="FeatureCollection") {
      geo = data;
    }
  } catch {}

  if (window.mapboxgl && CFG.MAPBOX_TOKEN) {
    mapboxgl.accessToken = CFG.MAPBOX_TOKEN;

    const map = new mapboxgl.Map({
      container:"geoMap",
      style:"mapbox://styles/mapbox/dark-v11",
      center:[-98,38],
      zoom:3
    });

    map.on("load",()=>{
      map.addSource("events",{ type:"geojson", data:geo });

      map.addLayer({
        id:"heat",
        type:"heatmap",
        source:"events",
        paint:{
          "heatmap-radius":20,
          "heatmap-intensity":1,
          "heatmap-opacity":0.85
        }
      });
    });
  }

  /* =============================
     AI INSIGHTS (STATIC FOR NOW)
  ============================= */
  document.getElementById("insights").innerHTML = `
    <div class="insight">
      Engagement is accelerating around high-acreage land parcels, suggesting acquisition-focused interest.
    </div>
    <div class="insight">
      Geographic clustering indicates sustained demand in Western U.S. regions.
    </div>
    <div class="insight">
      High-severity signals correlate strongly with repeat property views.
    </div>
  `;

})();
</script>

</body>
</html>
