<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="robots" content="noindex,nofollow"/>
  <title>Adex Holdings Trust | Admin</title>

  <!-- CONTEXT LOCK -->
  <script>
  (function () {
    if (location.pathname.startsWith("/cdn-cgi/access")) return;
    if (
      location.protocol !== "https:" ||
      location.hostname !== "adexholdings.com" ||
      location.pathname !== "/admin.html"
    ) {
      document.open();
      document.write(`
        <!doctype html>
        <html><body style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:Arial">
        <div><h2>Access Restricted</h2><p>This account has no access.</p></div>
        </body></html>
      `);
      document.close();
      throw new Error("Blocked context");
    }
  })();
  </script>

  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="assets/styles.css"/>

  <!-- Mapbox -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <!-- ✅ ADMIN LAYOUT FIXES -->
  <style>
    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden;
    }

    body.admin {
      display: flex;
      background: #0b0f14;
    }

    /* Sidebar */
    .adminSidebar {
      width: 240px;
      min-width: 240px;
      height: 100vh;
      position: sticky;
      top: 0;
      overflow-y: auto;
      z-index: 20;
    }

    /* Main content */
    .container.withSidebar {
      flex: 1;
      height: 100vh;
      overflow-y: auto;
      padding: 24px 28px 120px;
      box-sizing: border-box;
    }

    /* Cards spacing */
    .card {
      margin-bottom: 28px;
    }

    /* Tables should scroll horizontally if needed */
    .table {
      display: block;
      width: 100%;
      overflow-x: auto;
    }

    /* Prevent giant text scaling */
    h1, .h1 {
      font-size: 28px;
      line-height: 1.25;
    }

    /* Mobile fallback */
    @media (max-width: 980px) {
      body.admin {
        flex-direction: column;
      }

      .adminSidebar {
        width: 100%;
        height: auto;
        position: relative;
      }

      .container.withSidebar {
        height: auto;
        overflow: visible;
        padding: 18px;
      }
      /* ===============================
   OVERVIEW PERIOD KPI LAYOUT
=============================== */

.periodGrid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 18px;
  margin-top: 16px;
}

@media (max-width: 900px) {
  .periodGrid {
    grid-template-columns: 1fr;
  }
}

.periodCard {
  border: 1px solid var(--line);
  border-radius: 16px;
  background: radial-gradient(
      600px 220px at 20% -10%,
      rgba(217,177,95,.10),
      transparent 55%
    ),
    rgba(23,26,33,.85);
  padding: 16px;
  box-shadow: var(--shadow2);
}

.periodTitle {
  font-size: 14px;
  font-weight: 900;
  letter-spacing: .12em;
  text-transform: uppercase;
  color: var(--gold);
  margin-bottom: 12px;
}

.miniKpiGrid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
}

.miniKpi {
  border: 1px solid var(--line);
  border-radius: 14px;
  padding: 12px;
  background: rgba(0,0,0,.18);
  box-shadow: 0 8px 18px rgba(0,0,0,.25);
}

.miniKpiLabel {
  font-size: 11px;
  font-weight: 900;
  letter-spacing: .12em;
  text-transform: uppercase;
  color: var(--muted);
}

.miniKpiValue {
  font-size: 28px;
  font-weight: 950;
  margin-top: 4px;
}
    }
  </style>
</head>

<body class="admin">

<!-- SIDEBAR -->
<aside class="adminSidebar">
  <div class="sideBrand">
    <img src="assets/logo.png" alt="Adex Holdings Trust"/>
    <span>Admin</span>
  </div>
  <nav class="sideNav">
    <a href="#adminKPI" class="active">Overview</a>
    <a href="#propertyRanking">Engagement</a>
    <a href="#adminHeatmap">Heatmap</a>
    <a href="#eventsTable">Events</a>
    <a href="#adminList">Availability</a>
    <a href="#auditTable">Audit</a>
  </nav>
</aside>

<!-- MAIN -->
<div class="container withSidebar">

  <!-- TOP BAR -->
  <div class="nav">
    <div class="brand">
      <img src="assets/logo.png" alt="Logo"/>
      <div>
        <div class="title">ADEX HOLDINGS TRUST</div>
        <div class="subtitle">Admin Portal</div>
      </div>
    </div>
    <div id="whoami" class="badge">Loading identity…</div>
  </div>

  <!-- KPI -->
  <div class="card" id="adminKPI">
    <div class="kicker">Analytics</div>
    <div class="h1">Key Performance Indicators</div>
  </div>

  <!-- KPI DASHBOARD -->
  <div class="card" id="kpiDashboard">
    <div class="kicker">Analytics</div>
    <div class="h1">Overview Dashboard</div>
    <div class="periodGrid">

  <!-- LAST 7 DAYS -->
  <div class="periodCard">
    <div class="periodTitle">Last 7 Days</div>

    <div class="miniKpiGrid">
      <div class="miniKpi">
        <div class="miniKpiLabel">Total Events</div>
        <div class="miniKpiValue" id="kpi7Total">291</div>
      </div>

      <div class="miniKpi">
        <div class="miniKpiLabel">Property Views</div>
        <div class="miniKpiValue" id="kpi7Views">46</div>
      </div>

      <div class="miniKpi">
        <div class="miniKpiLabel">High Severity</div>
        <div class="miniKpiValue" id="kpi7High">37</div>
      </div>

      <div class="miniKpi">
        <div class="miniKpiLabel">Unique Properties</div>
        <div class="miniKpiValue" id="kpi7Unique">7</div>
      </div>
    </div>
  </div>

  <!-- LAST 30 DAYS -->
  <div class="periodCard">
    <div class="periodTitle">Last 30 Days</div>

    <div class="miniKpiGrid">
      <div class="miniKpi">
        <div class="miniKpiLabel">Total Events</div>
        <div class="miniKpiValue" id="kpi30Total">291</div>
      </div>

      <div class="miniKpi">
        <div class="miniKpiLabel">Property Views</div>
        <div class="miniKpiValue" id="kpi30Views">46</div>
      </div>

      <div class="miniKpi">
        <div class="miniKpiLabel">High Severity</div>
        <div class="miniKpiValue" id="kpi30High">37</div>
      </div>

      <div class="miniKpi">
        <div class="miniKpiLabel">Unique Properties</div>
        <div class="miniKpiValue" id="kpi30Unique">7</div>
      </div>
    </div>
  </div>

</div>
  </div>

  <!-- ENGAGEMENT -->
  <div class="card" id="propertyRanking">
    <div class="kicker">Analytics</div>
    <div class="h1">Property Engagement Ranking</div>
    <table class="table">
      <thead>
        <tr>
          <th>#</th><th>Property</th><th>Views</th>
          <th>High Severity</th><th>Score</th><th>Last Seen</th>
        </tr>
      </thead>
      <tbody id="engagementRankingBody"></tbody>
    </table>
  </div>

  <!-- HEATMAP -->
  <div class="card">
    <div class="kicker">Analytics</div>
    <div class="h1">Event Heatmap</div>
    <div id="adminHeatmap" style="height:420px;border-radius:12px;"></div>
  </div>

  <!-- EVENTS -->
  <div class="card" id="events">
    <div class="kicker">Analytics</div>
    <div class="h1">Tracked Events</div>
    <div id="adminControls"></div>
    <table class="table" id="eventsTable">
      <thead>
        <tr>
          <th>Time</th><th>Type</th><th>Property</th>
          <th>Location</th><th>Severity</th><th>IP / ASN</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- AVAILABILITY -->
  <div class="card" id="availability">
    <div class="kicker">Admin</div>
    <div class="h1">Rental Availability</div>
    <div id="adminList" class="availabilityGrid"></div>
    <div class="btnRow">
      <button id="saveBtn" class="btn primary">Save availability</button>
    </div>
  </div>

  <!-- AUDIT -->
  <div class="card" id="audit">
    <div class="kicker">Audit</div>
    <div class="h1">Admin Activity</div>
    <table class="table" id="auditTable">
      <thead>
        <tr>
          <th>Time</th><th>User</th><th>Action</th><th>Details</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<script src="assets/data.js"></script>
<script src="assets/app.js"></script>

    <script>
/* ===============================
   UI ENHANCEMENTS (HTML ONLY)
================================ */

// Sidebar collapse
collapseBtn.onclick = () =>
  sidebar.classList.toggle("collapsed");

// Mobile nav
mobileNavBtn.onclick = () =>
  sidebar.classList.toggle("open");

// Theme toggle
const themeBtn = document.getElementById("themeBtn");
themeBtn.onclick = () => {
  const t = document.body.dataset.theme === "dark" ? "light" : "dark";
  document.body.dataset.theme = t;
  localStorage.setItem("adminTheme", t);
};
document.body.dataset.theme = localStorage.getItem("adminTheme") || "dark";

// Breadcrumbs auto-update
const sections = [...document.querySelectorAll(".card")];
const bc = document.getElementById("breadcrumbs");

const obs = new IntersectionObserver(
  entries => {
    entries.forEach(e => {
      if (e.isIntersecting) {
        const title = e.target.querySelector(".h1")?.textContent;
        if (title) bc.innerHTML = `Admin <span>›</span> ${title}`;
      }
    });
  },
  { threshold: .3 }
);
sections.forEach(s => obs.observe(s));

// PST formatter
function fmtPST(ts) {
  return new Date(ts).toLocaleString("en-US", {
    timeZone: "America/Los_Angeles"
  });
}

// Auto-convert timestamps
setTimeout(() => {
  document.querySelectorAll("td").forEach(td => {
    if (td.textContent?.includes("T") && td.textContent.includes("Z")) {
      td.textContent = fmtPST(td.textContent.trim());
    }
  });
  const k = document.getElementById("kpiUpdated");
  if (k) k.textContent = "Last updated: " + fmtPST(new Date().toISOString());
}, 1200);
</script>
</body>
</html>
