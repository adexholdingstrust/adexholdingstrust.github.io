<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="robots" content="noindex,nofollow"/>
  <title>Adex Holdings Trust | Admin</title>

  <!-- CONTEXT LOCK -->
  <script>
  (function () {
    if (location.pathname.startsWith("/cdn-cgi/access")) return;
    if (
      location.protocol !== "https:" ||
      location.hostname !== "adexholdings.com" ||
      location.pathname !== "/admin.html"
    ) {
      document.open();
      document.write(`
        <!doctype html>
        <html><body style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:Arial">
        <div><h2>Access Restricted</h2><p>This account has no access.</p></div>
        </body></html>
      `);
      document.close();
      throw new Error("Blocked context");
    }
  })();
  </script>

  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="assets/styles.css"/>

  <!-- Mapbox -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <!-- ‚úÖ ADMIN LAYOUT FIXES -->
  <style>
    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden;
    }

    body.admin {
      display: flex;
      background: #0b0f14;
    }

    /* Sidebar */
    .adminSidebar {
      width: 240px;
      min-width: 240px;
      height: 100vh;
      position: sticky;
      top: 0;
      overflow-y: auto;
      z-index: 20;
    }

    /* Main content */
    .container.withSidebar {
      flex: 1;
      height: 100vh;
      overflow-y: auto;
      padding: 24px 28px 120px;
      box-sizing: border-box;
    }

    /* Cards spacing */
    .card {
      margin-bottom: 28px;
    }

    /* Tables should scroll horizontally if needed */
    .table {
      display: block;
      width: 100%;
      overflow-x: auto;
    }

    /* Prevent giant text scaling */
    h1, .h1 {
      font-size: 28px;
      line-height: 1.25;
    }

    /* Mobile fallback */
    @media (max-width: 980px) {
      body.admin {
        flex-direction: column;
      }

      .adminSidebar {
        width: 100%;
        height: auto;
        position: relative;
      }

      .container.withSidebar {
        height: auto;
        overflow: visible;
        padding: 18px;
      }
    }
    .thresholdForm {
  display: grid;
  grid-template-columns: 1fr;
  gap: 14px;
  max-width: 420px;
}

.thresholdForm label {
  display: flex;
  flex-direction: column;
  gap: 4px;
  font-size: 14px;
}

.thresholdForm input {
  padding: 6px 8px;
  border-radius: 6px;
  border: 1px solid #ccc;
}

.primaryBtn {
  margin-top: 10px;
  padding: 8px 12px;
  border-radius: 6px;
  background: #d9b15f;
  border: none;
  cursor: pointer;
}

.statusMsg {
  font-size: 13px;
  min-height: 16px;
}
    .funnelTable td,
.funnelTable th {
  text-align: left;
  padding: 8px;
}

.funnelTable .pct {
  font-weight: 600;
}

.funnelTable .drop {
  color: #ff6b6b;
}

.funnelTable .ok {
  color: #4cd964;
}

.muted {
  opacity: 0.65;
}
    .funnelControls {
  margin: 10px 0 16px;
  display: flex;
  gap: 12px;
  align-items: center;
}

.funnelControls select {
  padding: 6px 8px;
  border-radius: 6px;
}
  </style>
</head>

<body class="admin">

<!-- SIDEBAR -->
<aside class="adminSidebar">
  <div class="sideBrand">
    <img src="assets/logo.png" alt="Adex Holdings Trust"/>
    <span>Admin</span>
  </div>
  <nav class="sideNav">
    <a href="#kpiDashboard" class="active">Overview</a>
    <a href="#sessionInsights" class="active">Session Insight</a>
    <a href="#dwell" class="active">Per-Property Dwell Time</a>
    <a href="#funnels" class="active">Conversion Funnels</a>
    <a href="#realtime" class="active">Real-Time Event Stream</a>
    <a href="#anomalyDetection">Anomaly Detection & Alert Thresholds</a>
    <a href="#trafficSources">Traffic Sources</a>
    <a href="#deviceInsights">Device & Browser</a>
    <a href="#propertyRanking">Property Engagement Ranking</a>
    <a href="#adminHeatmap">Heatmap</a>
    <a href="#eventsTable">Events</a>
    <a href="#availability">Rental Availability</a>
    <a href="#propertyRanking">Engagement</a>
    <a href="#adminList">Change Property Status</a>
    <a href="#auditTable">Audit</a>
  </nav>
</aside>
<!-- MAIN -->
<div class="container withSidebar">
  
  <!-- TOP BAR -->
  <div class="nav">
    <div class="brand">
      <img src="assets/logo.png" alt="Logo"/>
      <div>
        <div class="title">ADEX HOLDINGS TRUST</div>
        <div class="subtitle">Admin Portal</div>
      </div>
    </div>
    <div id="whoami" class="badge">Loading identity‚Ä¶</div>
  </div>

     <!-- TOP BAR -->
  <!-- KPI 
  <div class="card" id="adminKPI">
    <div class="kicker">Analytics</div>
    <div class="h1">Key Performance Indicators</div>
  </div> -->
<!-- KPI ANCHOR (JS dependency only, no UI) -->
<div id="adminKPI" hidden></div>
  <!-- OVERVIEW DASHBOARD -->
<div class="card" id="kpiDashboard">
  <div class="kicker">Analytics</div>
  <div class="h1">Overview Dashboard</div>
  <!-- 7 / 30 DAY WRAPPER -->
  <div class="overviewGrid">

    <!-- LAST 7 DAYS -->
    <div class="overviewCard">
      <div class="overviewTitle">Last 7 Days</div>

      <div class="miniKpiGrid">
        <div class="miniKpi">
          <div class="miniLabel">Total Events</div>
          <div class="miniValue" id="kpi7Total">291</div>
          <canvas class="sparkline"></canvas>
        </div>

        <div class="miniKpi">
          <div class="miniLabel">Property Views</div>
          <div class="miniValue" id="kpi7Views">46</div>
          <canvas class="sparkline"></canvas>
        </div>

        <div class="miniKpi">
          <div class="miniLabel">High Severity</div>
          <div class="miniValue warn" id="kpi7High">37</div>
          <canvas class="sparkline"></canvas>
        </div>

        <div class="miniKpi">
          <div class="miniLabel">Unique Properties</div>
          <div class="miniValue" id="kpi7Unique">7</div>
          <canvas class="sparkline"></canvas>
        </div>
      </div>
    </div>

    <!-- LAST 30 DAYS -->
    <div class="overviewCard">
      <div class="overviewTitle">Last 30 Days</div>

      <div class="miniKpiGrid">
        <div class="miniKpi">
          <div class="miniLabel">Total Events</div>
          <div class="miniValue" id="kpi30Total">291</div>
          <canvas class="sparkline"></canvas>
        </div>

        <div class="miniKpi">
          <div class="miniLabel">Property Views</div>
          <div class="miniValue" id="kpi30Views">46</div>
          <canvas class="sparkline"></canvas>
        </div>

        <div class="miniKpi">
          <div class="miniLabel">High Severity</div>
          <div class="miniValue warn" id="kpi30High">37</div>
          <canvas class="sparkline"></canvas>
        </div>

        <div class="miniKpi">
          <div class="miniLabel">Unique Properties</div>
          <div class="miniValue" id="kpi30Unique">7</div>
          <canvas class="sparkline"></canvas>
        </div>
      </div>
    </div>

  </div>
</div>
<!-- EVENTS -->
<div class="card" id="events">
</div> <!-- END EVENTS CARD -->
<!-- SESSION INSIGHTS -->
<div class="card" id="sessionInsights">
  <div class="kicker">Behavior</div>
  <div class="h1">Session Insights</div>

  <div class="overviewGrid">
    <div class="overviewCard">
      <div class="miniLabel">Avg Session Duration</div>
      <div class="miniValue" id="avgSessionTime">‚Äî</div>
    </div>

    <div class="overviewCard">
      <div class="miniLabel">Pages per Session</div>
      <div class="miniValue" id="pagesPerSession">‚Äî</div>
    </div>

    <div class="overviewCard">
      <div class="miniLabel">Bounce Rate</div>
      <div class="miniValue" id="bounceRate">‚Äî</div>
    </div>
  </div>
</div>
  
  <!-- DWELL TIME (PER PROPERTY) -->
  <div class="card" id="dwell">
    <div class="kicker">Analytics</div>
    <div class="h1">Per-Property Dwell Time</div>
    <div class="small muted">Average time users spend on each property detail page.</div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;margin:12px 0;">
      <select id="dwellWindow">
        <option value="7">Last 7 days</option>
        <option value="30">Last 30 days</option>
        <option value="">All time</option>
      </select>
      <button id="dwellRefresh" class="btn">Refresh</button>
    </div>

    <table class="table" id="dwellTable">
      <thead>
        <tr>
          <th>Property</th>
          <th>Avg Dwell</th>
          <th>Median</th>
          <th>Sessions</th>
          <th>Last Seen</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- FUNNELS -->
<div class="card" id="conversionFunnels">
  <div class="kicker">Analytics</div>
  <div class="h1">Conversion Funnels</div>
  <div class="funnelControls">
  <label>
    Funnel Preset:
    <select id="funnelPreset">
      <option value="all">All Properties</option>
      <option value="rental">Rental Funnel</option>
      <option value="land">Land Funnel</option>
    </select>
  </label>
</div>


  <table class="table funnelTable">
    <thead>
      <tr>
        <th>Step</th>
        <th>Event</th>
        <th>Count</th>
        <th>Conversion</th>
        <th>Drop-off</th>
      </tr>
    </thead>
    <tbody id="funnelBody"></tbody>
  </table>

  <div id="funnelDebug" class="small muted"></div>
</div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;margin:12px 0;">
      <select id="funnelPreset">
        <option value="rental_interest">Rental Interest (View ‚Üí Maps ‚Üí Contact)</option>
        <option value="land_interest">Land Interest (View ‚Üí Maps ‚Üí Assessor)</option>
        <option value="tenant_intent">Tenant Intent (View ‚Üí Tenant Portal ‚Üí Submit)</option>
      </select>
      <select id="funnelWindow">
        <option value="7">Last 7 days</option>
        <option value="30">Last 30 days</option>
        <option value="">All time</option>
      </select>
      <button id="funnelRefresh" class="btn">Refresh</button>
    </div>

    <table class="table" id="funnelTable">
      <thead>
        <tr>
          <th>Step</th>
          <th>Users</th>
          <th>Conversion</th>
          <th>Drop-off</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
<!-- CONVERSION FUNNEL -->
<div class="card" id="conversionFunnel">
  <div class="kicker">Analytics</div>
  <div class="h1">Conversion Funnel</div>

  <table class="table">
    <thead>
      <tr>
        <th>Stage</th>
        <th>Count</th>
        <th>Conversion</th>
      </tr>
    </thead>
    <tbody id="funnelBody"></tbody>
  </table>
</div>

  <!-- REAL-TIME STREAM (SSE) -->
  <div class="card" id="realtime">
    <div class="kicker">Live</div>
    <div class="h1">Real-Time Event Stream</div>
    <div class="small muted">Streams events as they happen (requires SSE endpoint).</div>

    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:12px 0;">
      <span class="badge" id="sseStatus">Disconnected</span>
      <button class="btn" id="sseConnect">Connect</button>
      <button class="btn" id="sseDisconnect">Disconnect</button>
      <button id="connectStreamBtn" onclick="connectEventStream()"> Connect2 </button>
       <div id="realtimeStream" class="streamLog"></div>
      <label class="small" style="display:flex;gap:6px;align-items:center;">
        <input type="checkbox" id="sseAutoScroll" checked />
        Auto-scroll
      </label>
    </div>

    <div id="sseLog" style="height:220px;overflow:auto;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px;font-family:ui-monospace, SFMono-Regular, Menlo, monospace;font-size:12px;"></div>
  </div>


<!-- TRAFFIC SOURCES -->
<div class="card" id="trafficSources">
  <div class="kicker">Attribution</div>
  <div class="h1">Traffic Sources</div>

  <table class="table">
    <thead>
      <tr>
        <th>Referrer</th>
        <th>Visits</th>
      </tr>
    </thead>
    <tbody id="trafficSourceBody"></tbody>
  </table>
</div>

<!-- DEVICE INSIGHTS -->
<div class="card" id="deviceInsights">
  <div class="kicker">Environment</div>
  <div class="h1">Device & Browser</div>

  <table class="table">
    <thead>
      <tr>
        <th>User Agent</th>
        <th>Hits</th>
      </tr>
    </thead>
    <tbody id="uaBody"></tbody>
  </table>
</div>

  
  <!-- ENGAGEMENT -->
  <div class="card" id="propertyRanking">
    <div class="kicker">Analytics</div>
    <div class="h1">Property Engagement Ranking</div>
    <table class="table">
      <thead>
        <tr>
          <th>#</th><th>Property</th><th>Views</th>
          <th>High Severity</th><th>Score</th><th>Last Seen</th>
        </tr>
      </thead>
      <tbody id="engagementRankingBody"></tbody>
    </table>
  </div>

  <!-- HEATMAP -->
  <div class="card">
    <div class="kicker">Analytics</div>
    <div class="h1">Event Heatmap</div>
    <div id="adminHeatmap" style="height:420px;border-radius:12px;"></div>
  </div>
<!-- ALERT THRESHOLDS -->
<div class="card" id="alertThresholds">
  <div class="kicker">System</div>
  <div class="h1">Alert Thresholds</div>

  <form id="thresholdForm" class="thresholdForm">
    <label>
      Traffic Spike Ratio
      <input type="number" step="0.1" min="1" id="trafficSpikeRatio">
      <small>Alert if traffic exceeds baseline √ó this value</small>
    </label>

    <label>
      Property Spike Count
      <input type="number" min="1" id="propertySpikeCount">
      <small>Events from one property within 15 minutes</small>
    </label>

    <label>
      Severity Spike Count
      <input type="number" min="1" id="severitySpikeCount">
      <small>High severity events within 15 minutes</small>
    </label>

    <button type="submit" class="primaryBtn">
      Save Thresholds
    </button>

    <div id="thresholdStatus" class="statusMsg"></div>
  </form>
</div>


  <!-- EVENTS -->
  <div class="card" id="events">
    <div class="kicker">Analytics</div>
    <div class="h1">Tracked Events</div>
    <div id="adminControls"></div>
    <table class="table" id="eventsTable">
      <thead>
        <tr>
          <th>Time</th><th>Type</th><th>Property</th>
          <th>Location</th><th>Severity</th><th>IP / ASN</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- AVAILABILITY -->
  <div class="card" id="availability">
    <div class="kicker">Admin</div>
    <div class="h1">Rental Availability</div>
    <!-- PROPERTY CONTENT EDITOR -->
<div class="card" id="propertyEditor">
  <div class="kicker">Admin</div>
  <div class="h1">Edit Property Content</div>

  <select id="editorPropertySelect"></select>

  <label>Description / Summary</label>
  <textarea id="editorSummary" rows="3"></textarea>

  <label>Details</label>
  <textarea id="editorDetails" rows="5"></textarea>

  <label>Photo URLs (one per line)</label>
  <textarea id="editorPhotos" rows="4"></textarea>

  <label>Video Type</label>
  <select id="editorVideoType">
    <option value="">None</option>
    <option value="youtube">YouTube</option>
    <option value="vimeo">Vimeo</option>
    <option value="mp4">MP4</option>
  </select>

  <label>Video URL</label>
  <input id="editorVideoUrl" type="text"/>

  <button id="savePropertyContent" class="btn primary">
    Save Property Content
  </button>
</div>

    <div id="adminList" class="availabilityGrid"></div>
    <div class="btnRow">
      <button id="saveBtn" class="btn primary">Save availability</button>
    </div>
  </div>

  <!-- AUDIT -->
  <div class="card" id="audit">
    <div class="kicker">Audit</div>
    <div class="h1">Admin Activity</div>
    <table class="table" id="auditTable">
      <thead>
        <tr>
          <th>Time</th><th>User</th><th>Action</th><th>Details</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<script src="assets/data.js"></script>
<script src="assets/app.js"></script>

<script>
function fmtPST(ts) {
  return new Date(ts).toLocaleString("en-US", {
    timeZone: "America/Los_Angeles"
  });
}
</script>


  <script>
/* ===============================
   ADMIN KPI ENGINE (REAL DATA)
================================ */

const now = Date.now();
const DAY = 86400000;

function inRange(ts, days) {
  return new Date(ts).getTime() >= (now - days * DAY);
}

function buildTimeline(events, days) {
  const buckets = {};
  for (let i = days - 1; i >= 0; i--) {
    const d = new Date(now - i * DAY).toISOString().slice(0, 10);
    buckets[d] = 0;
  }
  events.forEach(e => {
    const d = e.ts.slice(0, 10);
    if (buckets[d] !== undefined) buckets[d]++;
  });
  return Object.values(buckets);
}

function computeMetrics(days) {
  const slice = ADMIN_EVENTS.filter(e => inRange(e.ts, days));
  return {
    total: slice.length,
    views: slice.filter(e => e.type === "view").length,
    high: slice.filter(e => e.severity >= 4).length,
    unique: new Set(slice.map(e => e.property)).size,
    timeline: buildTimeline(slice, days)
  };
}

/* ===============================
   PROPERTY ENGAGEMENT RANKING
================================ */

async function renderEngagementRanking() {
  const body = document.getElementById("engagementRankingBody");
  if (!body) return;

  body.innerHTML =
    `<tr><td colspan="6" style="opacity:.6;text-align:center">Loading engagement data‚Ä¶</td></tr>`;

  try {
    const res = await fetch(`/api/admin/events?limit=1000&_ts=${Date.now()}`, {
  credentials: "include",
  cache: "no-store"
});


    if (!res.ok) throw new Error("events fetch failed");

    const out = await res.json();
    const events = out.events || [];

    const map = {};

    events.forEach(e => {
      const property =
        e.data?.id ||
        e.data?.name ||
        e.data?.parcelId ||
        e.property ||
        null;

      if (!property) return;

      if (!map[property]) {
        map[property] = {
          views: 0,
          high: 0,
          lastSeen: e.ts
        };
      }

      if (e.eventType === "view_rental" || e.eventType === "view_land") {
        map[property].views++;
      }

      if (Number(e.severity) >= 4) {
        map[property].high++;
      }

      if (new Date(e.ts) > new Date(map[property].lastSeen)) {
        map[property].lastSeen = e.ts;
      }
    });

    const rows = Object.entries(map)
      .map(([property, v]) => ({
        property,
        views: v.views,
        high: v.high,
        score: v.views + v.high * 2,
        lastSeen: v.lastSeen
      }))
      .sort((a, b) => b.score - a.score);

    body.innerHTML = rows.length
      ? rows
          .map(
            (r, i) => `
            <tr>
              <td>${i + 1}</td>
              <td>${propertyLabel(r.property)}</td>
              <td>${r.views}</td>
              <td class="${r.high ? "warn" : ""}">${r.high}</td>
              <td>${r.score}</td>
              <td>${fmtPST(r.lastSeen)}</td>
            </tr>
          `
          )
          .join("")
      : `<tr><td colspan="6" style="opacity:.6;text-align:center">No engagement data yet</td></tr>`;
  } catch (err) {
    body.innerHTML =
      `<tr><td colspan="6" style="color:#ff6b6b;text-align:center">Failed to load engagement data</td></tr>`;
    console.error(err);
  }
}

// Friendly label helper (HTML-only)
function propertyLabel(val) {
  const rental = window.ADEX_DATA?.rentals?.find(p => p.id === val);
  if (rental) return rental.name;

  const land = window.ADEX_DATA?.lands?.find(l => l.id === val);
  if (land) return land.name;

  return val;
}
    /* ===============================
   CONVERSION FUNNELS
================================ */

async function renderConversionFunnels() {
  const body = document.getElementById("funnelBody");
  const debug = document.getElementById("funnelDebug");

  if (!body) return;

  body.innerHTML =
    `<tr><td colspan="5">Loading funnel data‚Ä¶</td></tr>`;

  try {
    const res = await fetch("/api/admin/events?limit=2000", {
      credentials: "include",
      cache: "no-store"
    });

    if (!res.ok) throw new Error("fetch failed");

    const { events } = await res.json();

    // Define funnel steps (order matters)
const preset =
  document.getElementById("funnelPreset")?.value || "all";

let steps;

if (preset === "rental") {
  steps = [
    { label: "View Rental", type: "view_rental" },
    { label: "Contact Click", type: "contact_click", propertyType: "rental" },
    { label: "Inquiry Submitted", type: "inquiry_submit", propertyType: "rental" }
  ];
} else if (preset === "land") {
  steps = [
    { label: "View Land", type: "view_land" },
    { label: "Contact Click", type: "contact_click", propertyType: "land" },
    { label: "Inquiry Submitted", type: "inquiry_submit", propertyType: "land" }
  ];
} else {
  steps = [
    { label: "Property View", type: ["view_rental", "view_land"] },
    { label: "Contact Click", type: "contact_click" },
    { label: "Inquiry Submitted", type: "inquiry_submit" }
  ];
}

    const counts = steps.map(step => ({
      ...step,
      count: events.filter(e => {
  const typeMatch = Array.isArray(step.type)
    ? step.type.includes(e.eventType)
    : e.eventType === step.type;

  const propMatch = step.propertyType
    ? e.propertyType === step.propertyType
    : true;

  return typeMatch && propMatch;
}).length
    }));

    const rows = [];
    let prev = counts[0]?.count || 0;

    counts.forEach((s, i) => {
      const conv =
        i === 0 || prev === 0
          ? "‚Äî"
          : `${Math.round((s.count / prev) * 100)}%`;

      const drop =
        i === 0
          ? "‚Äî"
          : `${prev - s.count}`;

      rows.push(`
        <tr>
          <td>${i + 1}</td>
          <td>${s.label}</td>
          <td>${s.count}</td>
          <td class="pct ${s.count ? "ok" : "drop"}">${conv}</td>
          <td class="drop">${drop}</td>
        </tr>
      `);

      prev = s.count;
    });

    body.innerHTML = rows.join("");

    debug.textContent =
      `Events analyzed: ${events.length} | Funnel steps: ${steps.length}`;

  } catch (e) {
    body.innerHTML =
      `<tr><td colspan="5">Failed to load funnel data</td></tr>`;
    debug.textContent = e.message;
  }
}

    /* ===============================
   ALERT THRESHOLD EDITOR
================================ */

async function loadThresholdEditor() {
  try {
    const res = await fetch("/api/admin/thresholds", {
      credentials: "include",
      cache: "no-store"
    });

    if (!res.ok) throw new Error("fetch failed");

    const { thresholds } = await res.json();

    document.getElementById("trafficSpikeRatio").value =
      thresholds.trafficSpikeRatio;

    document.getElementById("propertySpikeCount").value =
      thresholds.propertySpikeCount;

    document.getElementById("severitySpikeCount").value =
      thresholds.severitySpikeCount;

  } catch (e) {
    document.getElementById("thresholdStatus").textContent =
      "Failed to load thresholds";
  }
}

async function saveThresholds(e) {
  e.preventDefault();

  const status = document.getElementById("thresholdStatus");
  status.textContent = "Saving‚Ä¶";

  const payload = {
    trafficSpikeRatio: Number(
      document.getElementById("trafficSpikeRatio").value
    ),
    propertySpikeCount: Number(
      document.getElementById("propertySpikeCount").value
    ),
    severitySpikeCount: Number(
      document.getElementById("severitySpikeCount").value
    )
  };

  try {
    const res = await fetch("/api/admin/thresholds", {
      method: "POST",
      credentials: "include",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!res.ok) throw new Error("save failed");

    status.textContent = "Thresholds updated successfully";

    // Refresh anomaly + threshold views
    if (typeof renderAnomalies === "function") {
      renderAnomalies();
    }
    if (typeof renderThresholds === "function") {
      renderThresholds();
    }

  } catch (e) {
    status.textContent = "Failed to save thresholds";
  }
}
/* ===============================
   ALERT THRESHOLD DISPLAY
================================ */

async function renderThresholds() {
  const list = document.getElementById("thresholdList");
  if (!list) return;

  try {
    const res = await fetch("/api/admin/thresholds", {
      credentials: "include",
      cache: "no-store"
    });

    if (!res.ok) throw new Error("threshold fetch failed");

    const out = await res.json();
    const t = out.thresholds;

    list.innerHTML = `
      <li>üìà Traffic spike ratio: <b>${t.trafficSpikeRatio}√ó</b></li>
      <li>üè† Property spike count: <b>${t.propertySpikeCount}</b></li>
      <li>‚ö†Ô∏è Severity spike count: <b>${t.severitySpikeCount}</b></li>
    `;
  } catch (e) {
    list.innerHTML =
      `<li style="color:#ff6b6b">Failed to load thresholds</li>`;
  }
}
/* ===============================
   TRACKED EVENTS TABLE
================================ */

async function renderTrackedEvents() {
  const table = document.querySelector("#eventsTable tbody");
  if (!table) return;

  table.innerHTML =
    `<tr><td colspan="6" style="opacity:.6;text-align:center">Loading events‚Ä¶</td></tr>`;

  try {
    const res = await fetch("/api/admin/events?limit=500", {
      credentials: "include"
    });

    if (!res.ok) throw new Error("events fetch failed");

    const out = await res.json();
    const events = out.events || [];

    table.innerHTML = events.length
      ? events
          .map(e => `
            <tr>
              <td>${fmtPST(e.ts)}</td>
              <td>${e.eventType || e.type || "‚Äî"}</td>
              <td>${propertyLabel(e.property || e.data?.id || "‚Äî")}</td>
              <td>${e.location || e.data?.location || "‚Äî"}</td>
              <td class="${e.severity >= 4 ? "warn" : ""}">
                ${e.severity ?? "‚Äî"}
              </td>
              <td>${e.ip || "‚Äî"} ${e.asn ? `(${e.asn})` : ""}</td>
            </tr>
          `)
          .join("")
      : `<tr><td colspan="6" style="opacity:.6;text-align:center">No events found</td></tr>`;
  } catch (err) {
    table.innerHTML =
      `<tr><td colspan="6" style="color:#ff6b6b;text-align:center">Failed to load events</td></tr>`;
    console.error(err);
  }
}

    
/* ---------- Sparklines ---------- */
function drawSparkline(canvas, data) {
  if (!canvas) return;
  const ctx = canvas.getContext("2d");
  const w = canvas.width = canvas.offsetWidth;
  const h = canvas.height = canvas.offsetHeight;
  ctx.clearRect(0, 0, w, h);

  const max = Math.max(...data, 1);
  ctx.strokeStyle = "#d9b15f";
  ctx.lineWidth = 2;
  ctx.beginPath();

  data.forEach((v, i) => {
    const x = (i / (data.length - 1)) * w;
    const y = h - (v / max) * h;
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.stroke();
}

/* ---------- Trends ---------- */
function trend(curr, prev) {
  if (!prev) return "‚Äî";
  const pct = ((curr - prev) / prev) * 100;
  return `${pct >= 0 ? "‚Üë" : "‚Üì"} ${Math.abs(pct).toFixed(1)}%`;
}

/* ---------- Render ---------- */

(function waitForAdminEvents() {
  if (!window.ADMIN_EVENTS || !window.ADMIN_EVENTS.length) {
    setTimeout(waitForAdminEvents, 200);
    return;
  }

  const ADMIN_EVENTS = window.ADMIN_EVENTS;

  const m7 = computeMetrics(7);
  const m30 = computeMetrics(30);
  const p7 = computeMetrics(14);
  const p30 = computeMetrics(60);

  bind("kpi7", m7, p7);
  bind("kpi30", m30, p30);
})();


function bind(prefix, curr, prev) {
  const map = {
    Total: curr.total,
    Views: curr.views,
    High: curr.high,
    Unique: curr.unique
  };

  Object.entries(map).forEach(([k, v]) => {
    const el = document.getElementById(prefix + k);
    if (!el) return;

    el.textContent = v;
    const card = el.closest(".miniKpi");
    card.dataset.tip = `Trend: ${trend(v, prev[k.toLowerCase()])}`;
    drawSparkline(card.querySelector("canvas"), curr.timeline);
  });
}


/* ---------- Timestamp ---------- */
document.querySelectorAll(".overviewTitle").forEach(t => {
  t.insertAdjacentHTML(
    "beforeend",
    `<div class="small">Updated ${fmtPST(new Date())}</div>`
  );
});
  /* ---------- Engagement Ranking Bootstrap ---------- */
document.addEventListener("DOMContentLoaded", () => {
  if (document.getElementById("engagementRankingBody")) {
    renderEngagementRanking();
  }

  if (document.querySelector("#eventsTable tbody")) {
    renderTrackedEvents();
  }
});
// Refresh every 30s
setInterval(renderEngagementRanking, 30000);

// Refresh when tab becomes active
document.addEventListener("visibilitychange", () => {
  if (!document.hidden) {
    renderEngagementRanking();
  }
});
    document.addEventListener("DOMContentLoaded", () => {
  renderConversionFunnel();
  setInterval(renderConversionFunnel, 60000);

});
document.addEventListener("DOMContentLoaded", () => {
  renderThresholds();
});
document.addEventListener("DOMContentLoaded", () => {
  loadThresholdEditor();

  const form = document.getElementById("thresholdForm");
  if (form) {
    form.addEventListener("submit", saveThresholds);
  }
});
renderConversionFunnels();
setInterval(renderConversionFunnels, 60000);
document
  .getElementById("funnelPreset")
  ?.addEventListener("change", renderConversionFunnels);

    /* ===============================
   CONVERSION FUNNEL RENDER
================================ */

async function renderConversionFunnel() {
  const body = document.getElementById("funnelBody");
  if (!body) return;

  body.innerHTML =
    `<tr><td colspan="3" style="opacity:.6;text-align:center">Loading funnel‚Ä¶</td></tr>`;

  try {
    const res = await fetch("/api/admin/funnel", {
      credentials: "include",
      cache: "no-store"
    });

    if (!res.ok) throw new Error("funnel fetch failed");

    const { funnel } = await res.json();

    const stages = [
      ["Page Views", funnel.page_view],
      ["Property Views", funnel.property_view],
      ["Contact Clicks", funnel.contact],
      ["Inquiries", funnel.inquiry],
      ["Downloads", funnel.download]
    ];

    const base = stages[0][1] || 1;

    body.innerHTML = stages
      .map(([label, count], i) => {
        const prev = i === 0 ? base : stages[i - 1][1];
        const pct = prev ? ((count / prev) * 100).toFixed(1) : "0.0";

        return `
          <tr>
            <td>${label}</td>
            <td>${count}</td>
            <td>${pct}%</td>
          </tr>
        `;
      })
      .join("");
  } catch (err) {
    body.innerHTML =
      `<tr><td colspan="3" style="color:#ff6b6b;text-align:center">Failed to load funnel</td></tr>`;
    console.error(err);
  }
}
    /* ===============================
   ANOMALY DETECTION RENDER
================================ */

async function renderAnomalies() {
  const list = document.getElementById("anomalyList");
  if (!list) return;

  list.innerHTML = `<li style="opacity:.6">Scanning activity‚Ä¶</li>`;

  try {
    const res = await fetch("/api/admin/anomalies", {
      credentials: "include",
      cache: "no-store"
    });

    if (!res.ok) throw new Error("anomaly fetch failed");

    const out = await res.json();
    const anomalies = out.anomalies || [];

    if (!anomalies.length) {
      list.innerHTML = `<li style="opacity:.6">No anomalies detected</li>`;
      return;
    }

    list.innerHTML = anomalies
      .map(a => {
        switch (a.type) {
          case "traffic_spike":
            return `
              <li class="warn">
                üö® Traffic spike detected:
                ${a.recent} events vs avg ${a.baselineAvg} (${a.ratio}√ó)
              </li>`;
          case "property_spike":
            return `
              <li class="warn">
                üî• Property spike:
                ${a.properties.map(p => `${p.id} (${p.count})`).join(", ")}
              </li>`;
          case "severity_spike":
            return `
              <li class="warn">
                ‚ö†Ô∏è High-severity activity spike detected
              </li>`;
          default:
            return `<li>Unknown anomaly</li>`;
        }
      })
      .join("");
  } catch (err) {
    list.innerHTML =
      `<li style="color:#ff6b6b">Failed to load anomalies</li>`;
    console.error(err);
  }
}
/* ===============================
   SESSION / TRAFFIC / DEVICE ANALYTICS
================================ */

async function loadAdminBehaviorInsights() {
  const res = await fetch(`/api/admin/events?limit=1000&_ts=${Date.now()}`, {
    credentials: "include",
    cache: "no-store"
  });

  if (!res.ok) return;
  const { events } = await res.json();
  if (!events?.length) return;

  /* ---------- Session Metrics ---------- */
  const sessions = {};
  events.forEach(e => {
    const key = `${e.ip}|${e.userAgent || ""}`;
    sessions[key] ||= [];
    sessions[key].push(e);
  });

  let totalTime = 0;
  let pageCount = 0;
  let bounces = 0;

  Object.values(sessions).forEach(s => {
    s.sort((a, b) => new Date(a.ts) - new Date(b.ts));
    const duration =
      new Date(s[s.length - 1].ts) - new Date(s[0].ts);

    totalTime += Math.max(duration, 0);
    pageCount += s.length;
    if (s.length === 1) bounces++;
  });

  const sessionCount = Object.keys(sessions).length || 1;

  document.getElementById("avgSessionTime").textContent =
    Math.round(totalTime / sessionCount / 1000) + "s";

  document.getElementById("pagesPerSession").textContent =
    (pageCount / sessionCount).toFixed(2);

  document.getElementById("bounceRate").textContent =
    Math.round((bounces / sessionCount) * 100) + "%";

  /* ---------- Traffic Sources ---------- */
  const sources = {};
  events.forEach(e => {
    const src = e.referrer || "Direct";
    sources[src] = (sources[src] || 0) + 1;
  });

  document.getElementById("trafficSourceBody").innerHTML =
    Object.entries(sources)
      .sort((a, b) => b[1] - a[1])
      .map(
        ([src, n]) => `<tr><td>${src}</td><td>${n}</td></tr>`
      )
      .join("");

  /* ---------- Device / UA ---------- */
  const uas = {};
  events.forEach(e => {
    const ua = e.userAgent || "Unknown";
    uas[ua] = (uas[ua] || 0) + 1;
  });

  document.getElementById("uaBody").innerHTML =
    Object.entries(uas)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 10)
      .map(
        ([ua, n]) => `<tr><td>${ua}</td><td>${n}</td></tr>`
      )
      .join("");
}

/* ---------- Bootstrap ---------- */
document.addEventListener("DOMContentLoaded", () => {
});
loadAdminBehaviorInsights();
setInterval(renderAnomalies, 30000);

// Refresh with engagement ranking
setInterval(loadAdminBehaviorInsights, 30000);
    
document.addEventListener("DOMContentLoaded", () => {
  renderAnomalies();
});
</script>


    <script>
/* ===============================
   UI ENHANCEMENTS (HTML ONLY)
================================ 

// Sidebar collapse
collapseBtn.onclick = () =>
  sidebar.classList.toggle("collapsed");

// Mobile nav
mobileNavBtn.onclick = () =>
  sidebar.classList.toggle("open"); */

  const sidebar = document.querySelector(".adminSidebar");

const collapseBtn = document.getElementById("collapseBtn");
if (collapseBtn && sidebar) {
  collapseBtn.onclick = () => sidebar.classList.toggle("collapsed");
}

const mobileNavBtn = document.getElementById("mobileNavBtn");
if (mobileNavBtn && sidebar) {
  mobileNavBtn.onclick = () => sidebar.classList.toggle("open");
}


// Theme toggle
const themeBtn = document.getElementById("themeBtn");
if (themeBtn) {
  themeBtn.onclick = () => {
    const t = document.body.dataset.theme === "dark" ? "light" : "dark";
    document.body.dataset.theme = t;
    localStorage.setItem("adminTheme", t);
  };
}

document.body.dataset.theme = localStorage.getItem("adminTheme") || "dark";

// Breadcrumbs auto-update
// Breadcrumbs auto-update
const bc = document.getElementById("breadcrumbs");
const sections = document.querySelectorAll(".card");

if (bc && sections.length) {
  const obs = new IntersectionObserver(
    entries => {
      entries.forEach(e => {
        if (e.isIntersecting) {
          const title = e.target.querySelector(".h1")?.textContent;
          if (title) {
            bc.innerHTML = `Admin <span>‚Ä∫</span> ${title}`;
          }
        }
      });
    },
    { threshold: 0.3 }
  );

  sections.forEach(s => obs.observe(s));
}
/* ===============================
   REAL-TIME EVENT STREAM (SSE)
================================ */

let adminEventSource = null;

function connectEventStream() {
  if (adminEventSource) return;

  const output = document.getElementById("realtimeStream");
  const btn = document.getElementById("connectStreamBtn");

  adminEventSource = new EventSource("/api/admin/stream");

  btn.textContent = "Connected";
  btn.disabled = true;

  adminEventSource.addEventListener("event", e => {
    const data = JSON.parse(e.data);
    const row = document.createElement("div");
    row.textContent =
      `${fmtPST(data.ts)} | ${data.eventType} | ${data.data?.name || data.path}`;
    output.prepend(row);
  });

  adminEventSource.onerror = () => {
    btn.textContent = "Disconnected";
    btn.disabled = false;
    adminEventSource.close();
    adminEventSource = null;
  };
}
/* ===============================
   AUDIT TABLE PST FIX
================================ */

const auditTable = document.querySelector("#auditTable tbody");

if (auditTable) {
  const auditObserver = new MutationObserver(() => {
    auditTable.querySelectorAll("td").forEach(td => {
      const t = td.textContent?.trim();
      if (t && t.includes("T") && t.endsWith("Z")) {
        td.textContent = fmtPST(t);
      }
    });
  });

  auditObserver.observe(auditTable, {
    childList: true,
    subtree: true
  });
}

// Auto-convert timestamps
setTimeout(() => {
  document.querySelectorAll("td").forEach(td => {
    if (td.textContent?.includes("T") && td.textContent.includes("Z")) {
      td.textContent = fmtPST(td.textContent.trim());
    }
  });
  const k = document.getElementById("kpiUpdated");
  if (k) k.textContent = "Last updated: " + fmtPST(new Date().toISOString());
}, 1200);
</script>
</body>
</html>
