<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="robots" content="noindex,nofollow"/>
  <title>Adex Holdings Trust | Admin</title>

  <!-- HARD CONTEXT BLOCK -->
 <script>
(function () {
  // Allow Cloudflare Access internals
  if (location.pathname.startsWith("/cdn-cgi/access")) return;

  // Enforce final location only
  if (
    location.protocol !== "https:" ||
    location.hostname !== "adexholdings.com" ||
    location.pathname !== "/admin.html"
  ) {
    document.open();
    document.write(`
      <!doctype html>
      <html><head><title>Access Restricted</title></head>
      <body style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:Arial">
        <div>
          <h2>Access Restricted</h2>
          <p>This account has no access to this page.</p>
        </div>
      </body></html>
    `);
    document.close();
    throw new Error("Blocked context");
  }
})();
</script>

  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="assets/styles.css"/>

  <!-- NEW: Mapbox (heatmap) -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
</head>

<body>

<div class="container">

  <!-- NAV -->
  <div class="nav">
    <div class="brand">
      <img src="assets/logo.png" alt="Adex Holdings Trust logo"/>
      <div>
        <div class="title">ADEX HOLDINGS TRUST</div>
        <div class="subtitle">Admin Portal</div>
      </div>
    </div>
    <div id="whoami" class="badge">Loading identityâ€¦</div>
  </div>

  <div id="maintenanceBanner" class="notice danger" style="display:none">
    ðŸš¨ Maintenance Mode Active â€” Admin actions are disabled.
  </div>

  <!-- NEW: KPI SUMMARY -->
  <div class="card">
    <div class="kicker">Analytics</div>
    <div class="h1">Key Performance Indicators</div>
    <div id="adminKPI"></div>
  </div>
<!-- ADD: KPI DASHBOARD GRID (VISUAL UPGRADE ONLY) -->
<div class="card" id="kpiDashboard">

  <div class="kicker">Analytics</div>
  <div class="h1">Overview Dashboard</div>

  <div class="kpiGrid">

    <div class="kpiCard">
      <div class="kpiLabel">Total Events</div>
      <div class="kpiValue" id="kpiTotalEvents">â€”</div>
      <div class="kpiMeta">Last 30 days</div>
      <canvas id="sparkTotalEvents" height="28"></canvas>
    </div>

    <div class="kpiCard">
      <div class="kpiLabel">Property Views</div>
      <div class="kpiValue" id="kpiPropertyViews">â€”</div>
      <div class="kpiMeta">Rental + Land</div>
      <canvas id="sparkPropertyViews" height="28"></canvas>
    </div>

    <div class="kpiCard warning">
      <div class="kpiLabel">High Severity Events</div>
      <div class="kpiValue" id="kpiHighSeverity">â€”</div>
      <div class="kpiMeta">Severity â‰¥ threshold</div>
      <canvas id="sparkHighSeverity" height="28"></canvas>
    </div>

    <div class="kpiCard">
      <div class="kpiLabel">Unique Properties</div>
      <div class="kpiValue" id="kpiUniqueProperties">â€”</div>
      <div class="kpiMeta">Engaged listings</div>
      <canvas id="sparkUniqueProperties" height="28"></canvas>
    </div>

  </div>

  <div class="kpiFooter">
    ðŸ“© Last alert sent:
    <strong id="lastAlertTimestamp">Never</strong>
  </div>

</div>

<!-- ADD: PROPERTY ENGAGEMENT RANKING -->
<div class="card" id="propertyRanking">

  <div class="kicker">Analytics</div>
  <div class="h1">Property Engagement Ranking</div>

  <table class="table">
    <thead>
      <tr>
        <th>#</th>
        <th>Property</th>
        <th>Views</th>
        <th>High Severity</th>
        <th>Engagement Score</th>
        <th>Last Seen</th>
      </tr>
    </thead>
    <tbody id="engagementRankingBody">
      <!-- populated by app.js -->
    </tbody>
  </table>

</div>
  <!-- NEW: EVENT HEATMAP -->
  <div class="card">
    <div class="kicker">Analytics</div>
    <div class="h1">Event Heatmap</div>
    <div id="adminHeatmap" style="height:420px;border-radius:12px;overflow:hidden;"></div>
  </div>

  <!-- NEW: SEVERITY TUNING DASHBOARD -->
  <div class="card">
    <div class="kicker">Alerts</div>
    <div class="h1">Severity Tuning</div>

    <div class="form">
      <label>
        Minimum severity to trigger alerts
        <select id="severityThreshold">
          <option value="1">All events</option>
          <option value="3">Severity â‰¥ 3</option>
          <option value="4">Severity â‰¥ 4</option>
          <option value="5">Severity â‰¥ 5 (High value only)</option>
        </select>
      </label>

      <div class="small" style="opacity:.75;margin-top:6px;">
        This controls email alerts and high-priority monitoring.
      </div>

      <div class="btnRow" style="margin-top:10px;">
        <button id="saveSeverityBtn" class="btn primary">Save severity threshold</button>
      </div>
    </div>
  </div>

  <!-- EXISTING: AVAILABILITY (UNCHANGED) -->
 <div class="card compactAvailability">
  <div class="kicker">Admin</div>
  <div class="h1">Rental Availability</div>

  <!-- NEW: compact grid wrapper -->
  <div id="adminList" class="availabilityGrid"></div>

  <div class="btnRow">
    <button id="saveBtn" class="btn primary">Save availability</button>
  </div>
</div>


  <!-- EXISTING: AUDIT (UNCHANGED) -->
  <div class="card">
    <div class="kicker">Audit</div>
    <div class="h1">Admin Activity</div>
    <table class="table" id="auditTable">
      <thead>
        <tr>
          <th>Time</th>
          <th>User</th>
          <th>Action</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- EXISTING + EXTENDED: EVENTS -->
  <div class="card">
    <div class="kicker">Analytics</div>
    <div class="h1">Tracked Events</div>

    <!-- NEW: filter + CSV controls injected by /admin/ui.js -->
    <div id="adminControls"></div>

    <table class="table" id="eventsTable">
      <thead>
        <tr>
          <th>Time</th>
          <th>Type</th>
          <th>Property</th>
          <th>Location</th>
          <th>Severity</th>
          <th>IP / ASN</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<script src="assets/data.js"></script>

<script>
(async function () {
  const api = "https://adexholdings.com/api";

  /* ---------- IDENTITY ---------- */
  const whoRes = await fetch(api + "/whoami", { credentials: "include" });
  if (!whoRes.ok) {
    document.body.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:Arial">
        <div>
          <h2>Access Denied</h2>
          <p>You do not have permission to access this page.</p>
        </div>
      </div>
    `;
    return;
  }

  const who = await whoRes.json();
  document.getElementById("whoami").textContent = `Logged in as ${who.email}`;

  if (who.maintenance === true) {
    document.getElementById("maintenanceBanner").style.display = "block";
    document.getElementById("saveBtn").disabled = true;
  }

  /* ---------- AUDIT LOG ---------- */
  const auditRes = await fetch(api + "/admin/audit", { credentials: "include" });
  const auditJson = await auditRes.json();
  const auditBody = document.querySelector("#auditTable tbody");

  auditJson.log.forEach(e => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${e.ts}</td>
      <td>${e.email}</td>
      <td>${e.action}</td>
      <td>${e.details || ""}</td>
    `;
    auditBody.appendChild(tr);
  });

  /* ---------- EVENTS ---------- */
  const eventsRes = await fetch(api + "/admin/events", { credentials: "include" });
  const eventsJson = await eventsRes.json();
  const eventsBody = document.querySelector("#eventsTable tbody");

  eventsJson.events.forEach(e => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${e.ts}</td>
      <td>${e.eventType}</td>
      <td>${e.data?.name || e.data?.parcelId || "â€”"}</td>
      <td>${[e.city, e.region, e.country].filter(Boolean).join(", ")}</td>
      <td>${e.severity ?? "â€”"}</td>
      <td>${e.ip} (${e.asnOrg || "Unknown"})</td>
    `;
    eventsBody.appendChild(tr);
  });
})();
</script>

<script src="assets/app.js"></script>

</body>
</html>
