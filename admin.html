<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="robots" content="noindex,nofollow"/>
  <title>Adex Holdings Trust | Admin</title>

  <!-- CONTEXT LOCK -->
  <script>
  (function () {
    if (location.pathname.startsWith("/cdn-cgi/access")) return;
    if (
      location.protocol !== "https:" ||
      location.hostname !== "adexholdings.com" ||
      location.pathname !== "/admin.html"
    ) {
      document.open();
      document.write(`
        <!doctype html>
        <html><body style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:Arial">
        <div><h2>Access Restricted</h2><p>This account has no access.</p></div>
        </body></html>
      `);
      document.close();
      throw new Error("Blocked context");
    }
  })();
  </script>

  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="assets/styles.css"/>

  <!-- Mapbox -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <!-- âœ… ADMIN LAYOUT FIXES -->
  <style>
    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden;
    }

    body.admin {
      display: flex;
      background: #0b0f14;
    }

    /* Sidebar */
    .adminSidebar {
      width: 240px;
      min-width: 240px;
      height: 100vh;
      position: sticky;
      top: 0;
      overflow-y: auto;
      z-index: 20;
    }

    /* Main content */
    .container.withSidebar {
      flex: 1;
      height: 100vh;
      overflow-y: auto;
      padding: 24px 28px 120px;
      box-sizing: border-box;
    }

    /* Cards spacing */
    .card {
      margin-bottom: 28px;
    }

    /* Tables should scroll horizontally if needed */
    .table {
      display: block;
      width: 100%;
      overflow-x: auto;
    }

    /* Prevent giant text scaling */
    h1, .h1 {
      font-size: 28px;
      line-height: 1.25;
    }

    /* Mobile fallback */
    @media (max-width: 980px) {
      body.admin {
        flex-direction: column;
      }

      .adminSidebar {
        width: 100%;
        height: auto;
        position: relative;
      }

      .container.withSidebar {
        height: auto;
        overflow: visible;
        padding: 18px;
      }
    }
  </style>
</head>

<body class="admin">

<!-- SIDEBAR -->
<aside class="adminSidebar">
  <div class="sideBrand">
    <img src="assets/logo.png" alt="Adex Holdings Trust"/>
    <span>Admin</span>
  </div>
  <nav class="sideNav">
    <a href="#kpiDashboard" class="active">Overview</a>
    <a href="#propertyRanking">Engagement</a>
    <a href="#adminHeatmap">Heatmap</a>
    <a href="#eventsTable">Events</a>
    <a href="#adminList">Availability</a>
    <a href="#auditTable">Audit</a>
  </nav>
</aside>

<!-- MAIN -->
<div class="container withSidebar">

  <!-- TOP BAR -->
  <div class="nav">
    <div class="brand">
      <img src="assets/logo.png" alt="Logo"/>
      <div>
        <div class="title">ADEX HOLDINGS TRUST</div>
        <div class="subtitle">Admin Portal</div>
      </div>
    </div>
    <div id="whoami" class="badge">Loading identityâ€¦</div>
  </div>

  <!-- KPI 
  <div class="card" id="adminKPI">
    <div class="kicker">Analytics</div>
    <div class="h1">Key Performance Indicators</div>
  </div> -->
<!-- KPI ANCHOR (JS dependency only, no UI) -->
<div id="adminKPI" hidden></div>
  <!-- OVERVIEW DASHBOARD -->
<div class="card" id="kpiDashboard">
  <div class="kicker">Analytics</div>
  <div class="h1">Overview Dashboard</div>
  <!-- 7 / 30 DAY WRAPPER -->
  <div class="overviewGrid">

    <!-- LAST 7 DAYS -->
    <div class="overviewCard">
      <div class="overviewTitle">Last 7 Days</div>

      <div class="miniKpiGrid">
        <div class="miniKpi">
          <div class="miniLabel">Total Events</div>
          <div class="miniValue" id="kpi7Total">291</div>
          <canvas class="sparkline"></canvas>
        </div>

        <div class="miniKpi">
          <div class="miniLabel">Property Views</div>
          <div class="miniValue" id="kpi7Views">46</div>
          <canvas class="sparkline"></canvas>
        </div>

        <div class="miniKpi">
          <div class="miniLabel">High Severity</div>
          <div class="miniValue warn" id="kpi7High">37</div>
          <canvas class="sparkline"></canvas>
        </div>

        <div class="miniKpi">
          <div class="miniLabel">Unique Properties</div>
          <div class="miniValue" id="kpi7Unique">7</div>
          <canvas class="sparkline"></canvas>
        </div>
      </div>
    </div>

    <!-- LAST 30 DAYS -->
    <div class="overviewCard">
      <div class="overviewTitle">Last 30 Days</div>

      <div class="miniKpiGrid">
        <div class="miniKpi">
          <div class="miniLabel">Total Events</div>
          <div class="miniValue" id="kpi30Total">291</div>
          <canvas class="sparkline"></canvas>
        </div>

        <div class="miniKpi">
          <div class="miniLabel">Property Views</div>
          <div class="miniValue" id="kpi30Views">46</div>
          <canvas class="sparkline"></canvas>
        </div>

        <div class="miniKpi">
          <div class="miniLabel">High Severity</div>
          <div class="miniValue warn" id="kpi30High">37</div>
          <canvas class="sparkline"></canvas>
        </div>

        <div class="miniKpi">
          <div class="miniLabel">Unique Properties</div>
          <div class="miniValue" id="kpi30Unique">7</div>
          <canvas class="sparkline"></canvas>
        </div>
      </div>
    </div>

  </div>
</div>

  <!-- ENGAGEMENT -->
  <div class="card" id="propertyRanking">
    <div class="kicker">Analytics</div>
    <div class="h1">Property Engagement Ranking</div>
    <table class="table">
      <thead>
        <tr>
          <th>#</th><th>Property</th><th>Views</th>
          <th>High Severity</th><th>Score</th><th>Last Seen</th>
        </tr>
      </thead>
      <tbody id="engagementRankingBody"></tbody>
    </table>
  </div>

  <!-- HEATMAP -->
  <div class="card">
    <div class="kicker">Analytics</div>
    <div class="h1">Event Heatmap</div>
    <div id="adminHeatmap" style="height:420px;border-radius:12px;"></div>
  </div>

  <!-- EVENTS -->
  <div class="card" id="events">
    <div class="kicker">Analytics</div>
    <div class="h1">Tracked Events</div>
    <div id="adminControls"></div>
    <table class="table" id="eventsTable">
      <thead>
        <tr>
          <th>Time</th><th>Type</th><th>Property</th>
          <th>Location</th><th>Severity</th><th>IP / ASN</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- AVAILABILITY -->
  <div class="card" id="availability">
    <div class="kicker">Admin</div>
    <div class="h1">Rental Availability</div>
    <!-- PROPERTY CONTENT EDITOR -->
<div class="card" id="propertyEditor">
  <div class="kicker">Admin</div>
  <div class="h1">Edit Property Content</div>

  <select id="editorPropertySelect"></select>

  <label>Description / Summary</label>
  <textarea id="editorSummary" rows="3"></textarea>

  <label>Details</label>
  <textarea id="editorDetails" rows="5"></textarea>

  <label>Photo URLs (one per line)</label>
  <textarea id="editorPhotos" rows="4"></textarea>

  <label>Video Type</label>
  <select id="editorVideoType">
    <option value="">None</option>
    <option value="youtube">YouTube</option>
    <option value="vimeo">Vimeo</option>
    <option value="mp4">MP4</option>
  </select>

  <label>Video URL</label>
  <input id="editorVideoUrl" type="text"/>

  <button id="savePropertyContent" class="btn primary">
    Save Property Content
  </button>
</div>

    <div id="adminList" class="availabilityGrid"></div>
    <div class="btnRow">
      <button id="saveBtn" class="btn primary">Save availability</button>
    </div>
  </div>

  <!-- AUDIT -->
  <div class="card" id="audit">
    <div class="kicker">Audit</div>
    <div class="h1">Admin Activity</div>
    <table class="table" id="auditTable">
      <thead>
        <tr>
          <th>Time</th><th>User</th><th>Action</th><th>Details</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<script src="assets/data.js"></script>
<script src="assets/app.js"></script>

  <script>
/* ===============================
   ADMIN KPI ENGINE (REAL DATA)
================================ */

let ADMIN_EVENTS = [];

async function loadAdminEventsForKPI() {
  try {
    const res = await fetch("/api/admin/events?limit=2000", {
      credentials: "include"
    });
    if (!res.ok) return [];

    const out = await res.json();
    return out.events || [];
  } catch {
    return [];
  }
}
const now = Date.now();
const DAY = 86400000;

function inRange(ts, days) {
  return new Date(ts).getTime() >= (now - days * DAY);
}

function buildTimeline(events, days) {
  const buckets = {};
  for (let i = days - 1; i >= 0; i--) {
    const d = new Date(now - i * DAY).toISOString().slice(0, 10);
    buckets[d] = 0;
  }
  events.forEach(e => {
    const d = e.ts.slice(0, 10);
    if (buckets[d] !== undefined) buckets[d]++;
  });
  return Object.values(buckets);
}

function computeMetrics(days) {
  const slice = ADMIN_EVENTS.filter(e => inRange(e.ts, days));
  return {
    total: slice.length,
    views: slice.filter(e => e.type === "view").length,
    high: slice.filter(e => e.severity >= 4).length,
    unique: new Set(slice.map(e => e.property)).size,
    timeline: buildTimeline(slice, days)
  };
}
<script>
/* ===============================
   PROPERTY ENGAGEMENT RANKING
================================ */

async function renderEngagementRanking() {
  const body = document.getElementById("engagementRankingBody");
  if (!body || !ADMIN_EVENTS.length) return;

  const map = {};

  ADMIN_EVENTS.forEach(e => {
    if (!e.property) return;

    if (!map[e.property]) {
      map[e.property] = {
        views: 0,
        high: 0,
        lastSeen: e.ts
      };
    }

    if (e.type === "view") map[e.property].views++;
    if (e.severity >= 4) map[e.property].high++;

    if (new Date(e.ts) > new Date(map[e.property].lastSeen)) {
      map[e.property].lastSeen = e.ts;
    }
  });

  const rows = Object.entries(map)
    .map(([property, v]) => ({
      property,
      views: v.views,
      high: v.high,
      score: v.views + v.high * 2,
      lastSeen: v.lastSeen
    }))
    .sort((a, b) => b.score - a.score);

  body.innerHTML = rows
    .map((r, i) => `
      <tr>
        <td>${i + 1}</td>
        <td>${r.property}</td>
        <td>${r.views}</td>
        <td class="${r.high ? "warn" : ""}">${r.high}</td>
        <td>${r.score}</td>
        <td>${fmtPST(r.lastSeen)}</td>
      </tr>
    `)
    .join("");
}

/* ---------- Sparklines ---------- */
function drawSparkline(canvas, data) {
  if (!canvas) return;
  const ctx = canvas.getContext("2d");
  const w = canvas.width = canvas.offsetWidth;
  const h = canvas.height = canvas.offsetHeight;
  ctx.clearRect(0, 0, w, h);

  const max = Math.max(...data, 1);
  ctx.strokeStyle = "#d9b15f";
  ctx.lineWidth = 2;
  ctx.beginPath();

  data.forEach((v, i) => {
    const x = (i / (data.length - 1)) * w;
    const y = h - (v / max) * h;
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.stroke();
}

/* ---------- Trends ---------- */
function trend(curr, prev) {
  if (!prev) return "â€”";
  const pct = ((curr - prev) / prev) * 100;
  return `${pct >= 0 ? "â†‘" : "â†“"} ${Math.abs(pct).toFixed(1)}%`;
}

/* ---------- Render ---------- */
(async () => {
  ADMIN_EVENTS = await loadAdminEventsForKPI();

  const m7 = computeMetrics(7);
  const m30 = computeMetrics(30);
  const p7 = computeMetrics(14);
  const p30 = computeMetrics(60);

  bind("kpi7", m7, p7);
  bind("kpi30", m30, p30);

  renderEngagementRanking(); // ðŸ‘ˆ ADD THIS LINE
})();

function bind(prefix, curr, prev) {
  const map = {
    Total: curr.total,
    Views: curr.views,
    High: curr.high,
    Unique: curr.unique
  };

  Object.entries(map).forEach(([k, v]) => {
    const el = document.getElementById(prefix + k);
    if (!el) return;

    el.textContent = v;
    const card = el.closest(".miniKpi");
    card.dataset.tip = `Trend: ${trend(v, prev[k.toLowerCase()])}`;
    drawSparkline(card.querySelector("canvas"), curr.timeline);
  });
}

bind("kpi7", m7, p7);
bind("kpi30", m30, p30);

/* ---------- Timestamp ---------- */
document.querySelectorAll(".overviewTitle").forEach(t => {
  t.insertAdjacentHTML(
    "beforeend",
    `<div class="small">Updated ${fmtPST(new Date())}</div>`
  );
});
</script>


    <script>
/* ===============================
   UI ENHANCEMENTS (HTML ONLY)
================================ */

// Sidebar collapse
collapseBtn.onclick = () =>
  sidebar.classList.toggle("collapsed");

// Mobile nav
mobileNavBtn.onclick = () =>
  sidebar.classList.toggle("open");

// Theme toggle
const themeBtn = document.getElementById("themeBtn");
themeBtn.onclick = () => {
  const t = document.body.dataset.theme === "dark" ? "light" : "dark";
  document.body.dataset.theme = t;
  localStorage.setItem("adminTheme", t);
};
document.body.dataset.theme = localStorage.getItem("adminTheme") || "dark";

// Breadcrumbs auto-update
const sections = [...document.querySelectorAll(".card")];
const bc = document.getElementById("breadcrumbs");

const obs = new IntersectionObserver(
  entries => {
    entries.forEach(e => {
      if (e.isIntersecting) {
        const title = e.target.querySelector(".h1")?.textContent;
        if (title) bc.innerHTML = `Admin <span>â€º</span> ${title}`;
      }
    });
  },
  { threshold: .3 }
);
sections.forEach(s => obs.observe(s));

// PST formatter
function fmtPST(ts) {
  return new Date(ts).toLocaleString("en-US", {
    timeZone: "America/Los_Angeles"
  });
}
<script>
/* ===============================
   AUDIT TABLE PST FIX
================================ */

const auditTable = document.querySelector("#auditTable tbody");

if (auditTable) {
  const auditObserver = new MutationObserver(() => {
    auditTable.querySelectorAll("td").forEach(td => {
      const t = td.textContent?.trim();
      if (t && t.includes("T") && t.endsWith("Z")) {
        td.textContent = fmtPST(t);
      }
    });
  });

  auditObserver.observe(auditTable, {
    childList: true,
    subtree: true
  });
}
</script>

// Auto-convert timestamps
setTimeout(() => {
  document.querySelectorAll("td").forEach(td => {
    if (td.textContent?.includes("T") && td.textContent.includes("Z")) {
      td.textContent = fmtPST(td.textContent.trim());
    }
  });
  const k = document.getElementById("kpiUpdated");
  if (k) k.textContent = "Last updated: " + fmtPST(new Date().toISOString());
}, 1200);
</script>
</body>
</html>
