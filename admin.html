<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="robots" content="noindex,nofollow"/>
  <title>Adex Holdings Trust | Admin</title>

  <!-- HARD CONTEXT BLOCK -->
  <script>
    (function () {
      if (
        window.top !== window.self ||
        location.protocol !== "https:" ||
        location.hostname !== "adexholdings.com" ||
        location.pathname !== "/admin.html"
      ) {
        document.open();
        document.write(`
          <!doctype html>
          <html><head><title>Access Restricted</title></head>
          <body style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:Arial">
            <div>
              <h2>Access Restricted</h2>
              <p>This account has no access to this page.</p>
              <p>Please use the appropriate link or contact Adex Holdings, LLC or Adex Holdings Trust.</p>
            </div>
          </body></html>
        `);
        document.close();
        throw new Error("Blocked context");
      }
    })();
  </script>

  <link rel="icon" href="assets/logo.png"/>
  <link rel="stylesheet" href="assets/styles.css"/>
</head>

<body>

<div class="container">

  <div class="nav">
    <div class="brand">
      <img src="assets/logo.png" alt="Adex Holdings Trust logo"/>
      <div>
        <div class="title">ADEX HOLDINGS TRUST</div>
        <div class="subtitle">Admin Portal</div>
      </div>
    </div>
    <div id="whoami" class="badge">Loading identityâ€¦</div>
  </div>

  <div id="maintenanceBanner" class="notice danger" style="display:none">
    ðŸš¨ Maintenance Mode Active â€” Admin actions are disabled.
  </div>

  <!-- AVAILABILITY -->
  <div class="card">
    <div class="kicker">Admin</div>
    <div class="h1">Rental Availability</div>
    <div id="adminList" class="form"></div>
    <div class="btnRow">
      <button id="saveBtn" class="btn primary">Save availability</button>
    </div>
  </div>

  <!-- AUDIT -->
  <div class="card">
    <div class="kicker">Audit</div>
    <div class="h1">Admin Activity</div>
    <table class="table" id="auditTable">
      <thead>
        <tr>
          <th>Time</th>
          <th>User</th>
          <th>Action</th>
          <th>Details</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- EVENTS -->
  <div class="card">
    <div class="kicker">Analytics</div>
    <div class="h1">Tracked Events</div>
    <table class="table" id="eventsTable">
      <thead>
        <tr>
          <th>Time</th>
          <th>Type</th>
          <th>Property</th>
          <th>Location</th>
          <th>IP / ASN</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<script src="assets/data.js"></script>
<script>
(async function () {
  const api = "https://adexholdings.com/api";

  /* ---------- IDENTITY ---------- */
  const whoRes = await fetch(api + "/whoami");
  if (!whoRes.ok) {
    document.body.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:Arial">
        <div>
          <h2>Access Denied</h2>
          <p>You do not have permission to access this page.</p>
        </div>
      </div>
    `;
    return;
  }

  const who = await whoRes.json();
  document.getElementById("whoami").textContent = `Logged in as ${who.email}`;

  if (who.maintenance === true) {
    document.getElementById("maintenanceBanner").style.display = "block";
    document.getElementById("saveBtn").disabled = true;
  }

  /* ---------- AUDIT LOG ---------- */
  const auditRes = await fetch(api + "/admin/audit");
  const auditJson = await auditRes.json();
  const auditBody = document.querySelector("#auditTable tbody");

  auditJson.log.forEach(e => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${e.ts}</td>
      <td>${e.email}</td>
      <td>${e.action}</td>
      <td>${e.details || ""}</td>
    `;
    auditBody.appendChild(tr);
  });

  /* ---------- EVENTS ---------- */
  const eventsRes = await fetch(api + "/admin/events");
  const eventsJson = await eventsRes.json();
  const eventsBody = document.querySelector("#eventsTable tbody");

  eventsJson.events.forEach(e => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${e.ts}</td>
      <td>${e.eventType}</td>
      <td>${e.data?.name || e.data?.parcelId || "â€”"}</td>
      <td>${[e.city, e.region, e.country].filter(Boolean).join(", ")}</td>
      <td>${e.ip} (${e.asnOrg || "Unknown"})</td>
    `;
    eventsBody.appendChild(tr);
  });
})();
</script>

<script src="assets/app.js"></script>

</body>
</html>
