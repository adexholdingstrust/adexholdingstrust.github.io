<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Adex Holdings Trust | Finance</title>

  <link rel="icon" href="/assets/logo.png" />

  <style>
    :root{
      --bg:#0b0f14;
      --card:#0f1625;
      --line:rgba(255,255,255,.08);
      --txt:#ffffff;
      --muted:rgba(255,255,255,.65);
      --ok:#4cd964;
      --bad:#ff6b6b;
      --radius:16px;
    }

    *{box-sizing:border-box}

    body{
      margin:0;
      background:var(--bg);
      color:var(--txt);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    }

    .wrap{
      max-width:1300px;
      margin:0 auto;
      padding:24px 20px 60px;
    }

    /* Top bar */
    .top{
      display:flex;
      align-items:center;
      gap:14px;
      margin-bottom:24px;
    }

    .top img{
      height:42px;
    }

    .top .title{
      font-weight:700;
      letter-spacing:.05em;
    }

    .top .sub{
      font-size:12px;
      opacity:.6;
    }

    .card{
      background:var(--card);
      border-radius:var(--radius);
      border:1px solid var(--line);
      margin-bottom:20px;
    }

    .cardHead{
      padding:14px 18px;
      border-bottom:1px solid var(--line);
      font-weight:700;
    }

    .cardBody{
      padding:18px;
    }

    select,input,button{
      background:#101c33;
      border:1px solid #23355c;
      color:#fff;
      border-radius:10px;
      padding:8px 10px;
    }

    button{
      cursor:pointer;
    }

    .controls{
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:12px;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }

    th,td{
      padding:10px;
      border-bottom:1px solid var(--line);
      text-align:left;
      white-space:nowrap;
    }

    th{
      color:var(--muted);
      font-weight:600;
    }

    .pos{color:var(--ok)}
    .neg{color:var(--bad)}

    tfoot td{
      font-weight:700;
    }

    @media print{
      .controls{display:none}
    }
    .controls {
  align-items: stretch;
}

.controls > * {
  width: 100%;
  height: 100%;
}

#propertySelect {
  min-height: 140px;
}
    tbody tr {
  transition: background 0.15s ease;
}

tbody tr:hover {
  background: rgba(29, 78, 216, 0.12);
}
thead th {
  position: sticky;
  top: 0;
  background: #0f1625;
  z-index: 2;
}
    .kpiChip {
  background: #101c33;
  border: 1px solid #23355c;
  border-radius: 14px;
  padding: 14px 16px;
  min-width: 180px;
}

.kpiLabel {
  font-size: 12px;
  opacity: 0.6;
}

.kpiValue {
  font-size: 18px;
  font-weight: 700;
  margin-top: 4px;
}
.cardBody.tableScroll {
  max-height: 520px;
  overflow: auto;
}
    .riskChip {
  display: inline-block;
  padding: 4px 8px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 600;
  letter-spacing: .02em;
}

.risk-safe {
  background: rgba(76,217,100,.15);
  color: #4cd964;
}

.risk-90 {
  background: rgba(255,204,102,.18);
  color: #ffcc66;
}

.risk-60 {
  background: rgba(255,149,0,.18);
  color: #ff9500;
}

.risk-30 {
  background: rgba(255,107,107,.18);
  color: #ff6b6b;
}

.risk-expired {
  background: rgba(255,255,255,.15);
  color: #bbb;
}
/* ---- Drill-down modal ---- */

#propertyModal {
  position: fixed;
  inset: 0;
  z-index: 999;
}

.modalOverlay {
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,.55);
}

.modalCard {
  position: relative;
  background: #0f1625;
  border: 1px solid rgba(255,255,255,.12);
  border-radius: 18px;
  max-width: 720px;
  margin: 6vh auto;
  box-shadow: 0 30px 80px rgba(0,0,0,.6);
  display: flex;
  flex-direction: column;
}

.modalHead {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  border-bottom: 1px solid rgba(255,255,255,.1);
  font-weight: 700;
}

.modalHead button {
  background: none;
  border: none;
  color: #fff;
  font-size: 18px;
  cursor: pointer;
}

.modalBody {
  padding: 20px;
  max-height: 60vh;
  overflow: auto;
  font-size: 14px;
}

.modalGrid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 14px;
}

.modalItem {
  background: #101c33;
  border: 1px solid #23355c;
  border-radius: 12px;
  padding: 12px;
}

.modalLabel {
  font-size: 12px;
  opacity: .6;
}

.modalValue {
  font-weight: 700;
  margin-top: 4px;
}

@media print {
  #propertyModal { display: none !important; }
}
.kpiDelta {
  font-size: 12px;
  margin-top: 4px;
  display: inline-flex;
  align-items: center;
  gap: 4px;
  opacity: 0;
  transform: translateY(-4px);
  transition: opacity .25s ease, transform .25s ease;
}

.kpiDelta.show {
  opacity: 1;
  transform: translateY(0);
}

.kpiDelta.up {
  color: var(--ok);
}

.kpiDelta.down {
  color: var(--bad);
}
    td:not(:first-child),
th:not(:first-child) {
  text-align: right;
}
td:nth-child(11) {
  white-space: normal;
}

  </style>
</head>

<body>
<div class="wrap">

  <!-- HEADER -->
  <div class="top">
    <img src="/assets/logo.png" alt="Adex Holdings Trust" />
    <div>
      <div class="title">ADEX HOLDINGS TRUST</div>
      <div class="sub">Finance Overview</div>
    </div>
  </div>

  <!-- CONTROLS -->
  <div class="card">
    <div class="cardHead">View Options</div>
    <div class="cardBody controls">
        <input
          type="number"
          id="reserveInput"
          placeholder="Cash Reserves ($)"
          value="5000"
          onchange="renderTable()"
/>
  <div>
    <select id="propertySelect" multiple onchange="onPropertySelect()"></select>

    <div style="display:flex;gap:8px;margin-top:8px">
      <button onclick="selectAllProperties()">Select All</button>
      <button onclick="clearAllProperties()">Clear All</button>
    </div>
  </div>
      
      <select id="modeToggle" onchange="renderTable()">
        <option value="operator">Operator View</option>
        <option value="investor">Investor View</option>
     </select>

  <select id="viewMode" onchange="renderTable()">
    <option value="month">Monthly</option>
    <option value="year">Yearly</option>
  </select>

  <input type="month" id="monthSelect" onchange="renderTable()" />
</div>
  </div>

  <!-- TABLE -->
<div class="card">
  <div class="cardHead">Portfolio Snapshot</div>
  <div class="cardBody" style="display:flex;gap:14px;flex-wrap:wrap">
    <div class="kpiChip">
      <div class="kpiLabel">Monthly Rent</div>
      <div class="kpiValue" id="kpiRent">$0</div>
      <div class="kpiDelta" id="kpiRentDelta"></div>
    </div>

    <div class="kpiChip">
        <div class="kpiLabel">Portfolio Stress</div>
        <div class="kpiValue" id="kpiStress">â€”</div>
    </div>

    <div class="kpiChip">
      <div class="kpiLabel">Monthly Expenses</div>
      <div class="kpiValue" id="kpiExpenses">$0</div>
    </div>

    <div class="kpiChip">
      <div class="kpiLabel">Net Cash Flow</div>
      <div class="kpiValue" id="kpiNet">$0</div>
    </div>
    
    <div class="kpiChip">
      <div class="kpiLabel">Security Deposits Held</div>
      <div class="kpiValue" id="kpiDeposits">$0</div>
    </div>

    <div class="kpiChip">
      <div class="kpiLabel">Annual P&L</div>
      <div class="kpiValue" id="kpiAnnual">$0</div>
    </div>
  </div>
</div>

  <div class="card">
    <div class="cardHead">Financial Breakdown</div>
    <div class="cardBody tableScroll">
      <table>
<thead>
  <tr>
    <th>Property</th>
    <th>Rent</th>
    <th>Mortgage</th>
    <th>HOA</th>
    <th>Maintenance</th>
    <th>Taxes</th>
    <th>Total Expenses</th>
    <th>Monthly Net</th>
    <th>Annual Net</th>
    <th>Deposit</th>
    <th>Lease Dates</th>
    <th>DSCR</th>
  </tr>
</thead>
        <tbody id="financeBody"></tbody>

        <tfoot>
          <tr>
            <td>Totals</td>
            <td id="totalRent">â€”</td>
            <td colspan="4"></td>
            <td id="totalExpenses">â€”</td>
            <td></td>
            <td id="totalNet">â€”</td>
            <td colspan="2"></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

</div>

<script src="/assets/financials.js"></script>
<script src="/finance.js"></script>

<script>
  function depositExposureChip(deposit, rent) {
    if (!deposit || !rent) return "";

    const ratio = deposit / rent;

    if (ratio < 0.5) {
      return `<span class="riskChip risk-safe">Low</span>`;
    }
    if (ratio < 1) {
      return `<span class="riskChip risk-60">Moderate</span>`;
    }
    return `<span class="riskChip risk-30">High</span>`;
  }

  /* âœ… ADD THIS FUNCTION RIGHT BELOW */
  function reserveStressLiabilityAware(netMonthly, reserve, deposits) {
    if (netMonthly >= 0) return "ðŸŸ¢ Stable";

    const usableReserve = Math.max(reserve - deposits, 0);

    if (usableReserve === 0) return "ðŸ”´ No Buffer";

    const months = Math.floor(usableReserve / Math.abs(netMonthly));

    if (months >= 6) return "ðŸŸ¡ Watch";
    if (months >= 3) return "ðŸŸ  Tight";
    return "ðŸ”´ High Risk";
  }
/* ---------------------------------------
   EXTEND RENDERING (FRONTEND ONLY)
--------------------------------------- */
const _renderTable = renderTable;
renderTable = function () {
  const body = document.getElementById("financeBody");
  if (!body) return;

  body.innerHTML = "";
const reserve = Number(
  document.getElementById("reserveInput")?.value || 0
);
const userMode =
  document.getElementById("modeToggle")?.value || "operator";

  const mode = document.getElementById("viewMode")?.value || "month";

  let totals = { rent:0, expenses:0, net:0, deposits:0 };

  PROPERTIES
    .filter(p => SELECTED.has(p.id))
    .forEach(p => {
      const f = FINANCIALS[p.id] || {};

      const rent = Number(f.rent || 0);
      const mortgage = Number(f.mortgage || 0);
      const hoa = Number(f.hoa || 0);
      const maintenance =
  userMode === "operator"
    ? Number(f.maintenance || 0)
    : 0;
      const tax = Number(f.tax || 0);

      const expenses = mortgage + hoa + tax + maintenance;
      const monthlyNet = rent - expenses;
      const annualNet = monthlyNet * 12;

      totals.rent += rent;
      totals.expenses += expenses;
      totals.net += mode === "year" ? annualNet : monthlyNet;
      totals.deposits += Number(f.deposit || 0);

      const tr = document.createElement("tr");
tr.innerHTML = `
  <td>${p.name}</td>

  <td>${usd(rent)}</td>
  <td>${usd(mortgage)}</td>
  <td>${usd(hoa)}</td>
  <td>${usd(maintenance)}</td>
  <td>${usd(tax)}</td>

  <td>${usd(expenses)}</td>

  <td class="${monthlyNet >= 0 ? "pos" : "neg"}">
    ${usd(monthlyNet)}
  </td>

  <td class="${annualNet >= 0 ? "pos" : "neg"}">
    ${usd(annualNet)}
  </td>

  <td>${usd(f.deposit || 0)}</td>

  <td>
    ${f.rentStartDate || "â€”"} â†’ ${f.rentEndDate || "â€”"}
    <div style="margin-top:4px">
      ${leaseRiskChip(f.rentEndDate)}
    </div>
  </td>

  <td>
    ${
      mortgage > 0
        ? (rent / mortgage).toFixed(2)
        : "â€”"
    }
  </td>
`;
      body.appendChild(tr);
    });

  document.getElementById("totalRent").textContent = `$${totals.rent}`;
  document.getElementById("totalExpenses").textContent = `$${totals.expenses}`;
  document.getElementById("totalNet").textContent = `$${totals.net}`;
  if (document.getElementById("kpiRent"))
  document.getElementById("kpiRent").textContent = `$${totals.rent}`;
  document.getElementById("kpiExpenses").textContent = `$${totals.expenses}`;
  document.getElementById("kpiNet").textContent = `$${totals.net}`;
  document.getElementById("kpiAnnual").textContent =
  `$${mode === "year" ? totals.net : totals.net * 12}`;
  if (document.getElementById("kpiDeposits")) {
  document.getElementById("kpiDeposits").textContent = `$${totals.deposits}`;
}
  const stress = reserveStressLiabilityAware(
  totals.net,
  reserve,
  totals.deposits
);

const stressEl = document.getElementById("kpiStress");
if (stressEl) stressEl.textContent =
  userMode === "operator" ? stress : "â€”";

};

</script>
<!-- DRILL-DOWN MODAL -->
<div id="propertyModal" style="display:none">
  <div class="modalOverlay" onclick="closePropertyModal()"></div>

  <div class="modalCard">
    <div class="modalHead">
      <div id="modalTitle">Property Details</div>
      <button onclick="closePropertyModal()">âœ•</button>
    </div>

    <div class="modalBody" id="modalContent"></div>
  </div>
</div>

</body>
</html>
